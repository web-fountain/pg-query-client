<!-- 3f913075-c437-4d1f-9ec5-31b2490f8f8c 166ef965-5f9f-4c19-bb81-3917f250db9c -->
# Move query name dispatch into Toolbar

### Goals

- **Preserve 200ms debounce** and **flush before onSave**.
- **Keep saveDisabled computed in parent** so visual behavior stays identical.
- **Remove now-unused name-debounce in QueryWorkspace**.
- **Cancel pending debounced commit on active tab change** and **pass dataQueryId to the debounced function** to prevent cross-tab updates.

### Files to change

- `src/app/opspace/[opspaceId]/queries/[dataQueryId]/_components/QueryWorkspace/Toolbar/index.tsx`
- `src/app/opspace/[opspaceId]/queries/[dataQueryId]/_components/QueryWorkspace/index.tsx`

### Steps

1. Update Toolbar props and wiring

   - Remove `onQueryNameChange` from `Props` and JSX usage.
   - Keep existing props: `queryName`, `isRunning`, `saveDisabled`, `isSaving`, `onRun`, `onSave`.

2. Make Toolbar Redux-aware (scoped)

   - Import `useReduxDispatch`, `useReduxSelector`.
   - Import `selectActiveTabId` and `updateDataQueryName`.
   - Read `activeTabId` inside `Toolbar`.

3. Implement debounced name commit inside Toolbar

   - Create `debouncedCommit = useDebouncedCallback((id: string | null, name: string) => { if (!id) return; dispatch(updateDataQueryName({ dataQueryId: id, name })); }, 200);`
   - On `activeTabId` change: flush to the previous tab id with the latest `queryName` (no cancel).
   - In `onNameChange`, set local state and call `debouncedCommit(activeTabId, name)`.
   - In `handleSaveClick`, call `debouncedCommit.flush(activeTabId, queryName)` before `onSave(queryName)`.

4. Simplify QueryWorkspace

   - Remove `onQueryNameChange` prop when rendering `Toolbar`.
   - Delete the now-unused parent name debounce (`debouncedCommitName`) and its cancel `useEffect`.
   - Keep `saveDisabled` calculation unchanged in `QueryWorkspace` so button styling/UX stays identical.

5. Validate behavior

   - Ensure quick tab switches do not apply the last keystroke to the prior tab (covered by id-arg + cancel-on-tab-change).
   - Ensure the last character before Save is included (flush in `handleSaveClick`).
   - Confirm no CSS changes and that disabled/hover/spinner states are unaffected.

### Key snippets (illustrative)

```tsx
// Toolbar: debounced commit scoped by id
const debouncedCommit = useDebouncedCallback((id: string | null, next: string) => {
  if (!id) return;
  dispatch(updateDataQueryName({ dataQueryId: id, name: next }));
}, 200);

useEffect(() => { try { (debouncedCommit as any).cancel?.(); } catch {} }, [activeTabId, debouncedCommit]);

const onNameChange = (e: ChangeEvent<HTMLInputElement>) => {
  const name = e.target.value;
  setQueryName(name);
  debouncedCommit(activeTabId, name);
};

const handleSaveClick = () => {
  try { (debouncedCommit as any).flush?.(activeTabId, queryName); } catch {}
  onSave(queryName);
};
```



```tsx
// QueryWorkspace: render Toolbar without onQueryNameChange
<Toolbar
  queryName={(activeDataQueryRecord?.current?.name ?? activeDataQueryRecord?.persisted?.name ?? 'Untitled') as string}
  isRunning={isRunning}
  onRun={runFromToolbar}
  onSave={saveFromToolbar}
  saveDisabled={/* existing computation */}
  isSaving={isSaving}
/>
```

### Notes

- No CSS module or styling changes are required.
- `saveFromToolbar` may continue to accept `queryName` (even if unused), or you can remove the param in a follow-up refactor.

### To-dos

- [ ] Remove onQueryNameChange prop; keep other props intact
- [ ] Inject dispatch and activeTabId into Toolbar
- [ ] Implement 200ms debounced name dispatch with id argument
- [ ] Cancel pending debounce when activeTabId changes
- [ ] Flush debounced commit before calling onSave
- [ ] Render Toolbar without onQueryNameChange; keep saveDisabled logic
- [ ] Remove debouncedCommitName and its cancel effect from QueryWorkspace
- [ ] Verify cross-tab typing, save flush, and unchanged styling